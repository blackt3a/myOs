第2章

### 计算机启动过程

加电- >BIOS加载到内存，cpu初始化->运行BIOS->MBR->OS

### 软件竭力第一棒，BIOS

在实模式下，寻址1M的内存地址

![](https://i.imgur.com/yD56qV3.png)

加电后，CPU的`cs：ip`寄存器被强制初始化为`0xF000:0xFFF0`，执行实模式下`0xFFFF0`处的跳转指令。该跳转指向的是`1M`内存空间的顶端，即地址`0xF0000~0xFFFFF`，也是BIOS最终真正的位置。

在执行BIOS时，其并不是真正在内存中，而是在`ROM`中，只不过看作在内存中

![](https://i.imgur.com/MjNe1dq.png)



BIOS启动后会校验启动盘0盘0道1扇区的内容，通常这里会是`MBR`，通过硬指令`jmp 0:0x7c00`实现。

(也就是说，如果该地址没有内容或者出错，直接寄。)

至于为什么是`0x700`。en。。。。

#### NASM

![](https://i.imgur.com/CRczAEi.png)

会用到的是bin和elf格式。两者之间的区别是，`bin`是可直接单独运行，`elf`可能还需要额外的外部链接。





### 关于MBR

mbr中vstart和org是一样的，

使用`vstart=xxx`并不能是程序被加载到相关位置，只是告诉编译器，编译时，程序中的地址以`xxx`为起始地址，在二进制指令中的一些`跳转`或这`绝对值地址`会涉及。

使用vstart的时机是：我事先知道我的程序会被加载到哪个地址。否则CPU将找不到指令中的一些地址。



### CPU的实模式

CPU中的实模式是为兼容兼容16位(此时此刻将自己假装成一个16位的CPU)



#### CPU的工作原理

。。。。。



#### 实模式分段的由来

8086CPU的地址总线有20根，支持2的20次方，也就是`1M`的内存空间。但是其内部寄存器却都是16位的。若用单一寄存器来寻址的只能的访问到2的16次方，也就是`64KB`

为了让16位的寄存器寻址`1M`的空间，就需要用两个寄存器配合（2x16 > 20）。

在实模式下，如果地址大于`1M`，其最终将会被取模

所以，从实模式到保护模式需要打开A20地址线(当然，这是后话了)



### 关于显卡

其通过软件指令与上层接口通信，显卡也有自己的BIOS,位置是`0xC000`到`0xC7FFF`。

显卡支持三种模式：

- 文本模式
- 黑白图模式
- 彩色图模式



内存从`0xB8000`到`0xBFFFF`这`32KB`的内存用于文本显示，我们往`0xB8000`处输出的字符会直接落到现存中，然后投放到屏幕上

> tips：一页文本25x80=2000,一个字符两个字节，32KB共可储存8页。所以alt+fn实现tty的切换
